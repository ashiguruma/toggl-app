<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Toggl App</title>

        <link rel="stylesheet" href="bower_components/html5-boilerplate/dist/css/normalize.css">
        <link rel="stylesheet" href="bower_components/html5-boilerplate/dist/css/main.css">

        <style>
            html {
                box-sizing: border-box;
            }
            *, *:before, *:after {
                box-sizing: inherit;
            }

            #app {
                margin: 40px;
            }

            #task-entry .container {
                float: left;
            }
            #task-description-container {
                width: 70%;
            }
            #task-description-container input {
                width: 100%;
            }
            #task-project-container {
                width: 20%
            }
            #task-project-container select {
                width: 100%;
            }
            #task-start {
                width: 10%;
            }
        </style>

        <script src="bower_components/react/react.js"></script>
        <script src="bower_components/react/react-dom.js"></script>
        <script src="bower_components/babel/browser.js"></script>
        <script src="bower_components/moment/min/moment.min.js"></script>

        <script src="config.js"></script>

        <script type="text/babel">
        var ajax = function(options) {
            var request = new XMLHttpRequest();
            request.open("GET", options.url, true);

            Object.keys(options.headers).forEach(function(header) {
                request.setRequestHeader(header, options.headers[header]);
            });

            request.onload = function(event) {
                if (request.status == 200 && request.status < 400) {
                    var result = JSON.parse(request.responseText);

                    if (typeof options.success === "function") {
                        options.success(result, event);
                    }
                } else {
                    options.error(event, request);
                    console.error("There was a server error", request, event);
                }
            };

            request.onerror = function(event) {
                options.error(event, request);
                console.error("There was an error with the request", request, event);
            };

            request.send();
        }

        var EntryForm = React.createClass({
            handleSubmit: function(event) {
                event.preventDefault();
                var form = event.target;

                var task = {
                    name: form.querySelector("#task-name").value,
                    project: form.querySelector("#task-project").value
                }
            },

            render: function() {
                return <form id="task-entry" onSubmit={this.handleSubmit}>
                    <div id="task-description-container" className="container">
                        <label htmlFor="task-description" className="visuallyhidden focusable">Describe your task</label>
                        <input type="text" name="taskName" id="task-description" placeholder="e.g. Writing, Bugfixing in IE" />
                    </div>

                    <Projects />

                    <button type="submit" id="task-start">start</button>
                </form>
            }
        });

        var Projects = React.createClass({
            getInitialState: function() {
                return {
                    projects: []
                };
            },

            componentDidMount: function() {
                ajax({
                    url: app.config.api.endpoint + "workspaces/" + workspaceID + "/projects",
                    headers: {
                        "Authorization": "Basic " + btoa(app.config.api.token + ":api_token")
                    },
                    success: (function(result) {
                        if (this.isMounted()) {
                            this.setState({projects: result});
                        }
                    }).bind(this)
                });
            },

            render: function() {
                var projectEntry = function(project) {
                    return <option key={project.id} value={project.id}>{project.name}</option>
                };

                return <div id="task-project-container" className="container">
                    <label htmlFor="task-project" className="visuallyhidden focusable">Project</label>
                    <select id="task-project" name="taskProject">
                        <option>Select a project&hellip;</option>
                        {this.state.projects.map(projectEntry)}
                    </select>
                </div>

            }
        });

        var EntriesList = React.createClass({
            render: function() {
                var createEntry = function(entry) {
                    return <li key={entry.id}>
                            {entry.description}
                        </li>
                }
                return <ul>{this.props.entries.map(createEntry)}</ul>
            }
        });

        var RecentEntries = React.createClass({
            getInitialState: function() {
                return {
                    entries: []
                };
            },

            componentDidMount: function() {
                ajax({
                    url: app.config.api.endpoint + "time_entries",
                    headers: {
                        "Authorization": "Basic " + btoa(app.config.api.token + ":api_token")
                    },
                    success: (function(result) {
                        if (this.isMounted()) {
                            this.setState({entries: result});
                        }
                    }).bind(this)
                });
            },

            render: function() {
                this.state.entries.sort(function(a, b) {
                    var aDate = new Date(a.at);
                    var bDate = new Date(b.at);

                    if (aDate > bDate) {
                        return -1
                    } else if (aDate < bDate) {
                        return 1;
                    } else {
                        return 0;
                    }
                });
                return (
                    <div>
                        <h3>Previous Entries</h3>
                        <EntriesList entries={this.state.entries} />
                    </div>
                );
            }
        });

        ReactDOM.render(
            <div>
                <EntryForm />
                <RecentEntries source="https://www.toggl.com/api/v8/time_entries" />
            </div>,
            document.getElementById("app")
        );
        </script>
    </head>
    <body>

        <div id="app">

        </div>

    </body>
</html>
